<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Healthimpro — Central Grid 10cm</title>
<style>
  body { margin:0; background:#000; overflow:hidden; font-family:Arial,sans-serif; }
  #stage { position:relative; width:100vw; height:100vh; }
  video, canvas { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
  canvas { pointer-events:none; }

  #controls{
    position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
    display:flex; gap:8px; padding:10px 12px;
    background:rgba(0,0,0,.65); border-radius:12px; z-index:10; color:#fff;
    align-items:center;
  }
  input, button{ font-size:16px; padding:10px 12px; border-radius:10px; border:none; }
  button{ background:#1f2937; color:#fff; }

  #countdown{
    position:fixed; inset:0; display:none;
    align-items:center; justify-content:center;
    font-size:72px; color:#fff; background:rgba(0,0,0,.55); z-index:20;
  }

  /* Result view */
  #result{
    position:fixed; inset:0; background:#000; z-index:30; display:none;
    flex-direction:column;
  }
  #resultBar{
    display:flex; gap:10px; padding:12px;
    background:rgba(0,0,0,.75); color:#fff; align-items:center;
  }
  #resultBar button{ background:#1f2937; }
  #hint{ font-size:12px; opacity:.85; }
  #resultImgWrap{ flex:1; display:flex; align-items:center; justify-content:center; }
  #resultImg{ max-width:100%; max-height:100%; width:100%; height:auto; }
</style>
</head>
<body>

<div id="stage">
  <video id="video" playsinline muted></video>
  <canvas id="overlay"></canvas>
</div>

<div id="countdown">8</div>

<div id="controls">
  <input id="heightCm" type="number" min="80" max="250" placeholder="Рост (см)">
  <button id="btnStart">Камера</button>
  <button id="btnSwitch">↔</button>
  <button id="btnPhoto">Фото</button>
</div>

<div id="result">
  <div id="resultBar">
    <button id="btnBack">Назад</button>
    <button id="btnShare">Поделиться</button>
    <div id="hint">iPhone: удерживай палец на фото → «Сохранить в Фото»</div>
  </div>
  <div id="resultImgWrap">
    <img id="resultImg" alt="result">
  </div>
</div>

<script>
(() => {
  const video = document.getElementById('video');
  const canvas = document.getElementById('overlay');
  const ctx = canvas.getContext('2d');

  const heightInput = document.getElementById('heightCm');
  const countdown = document.getElementById('countdown');

  const btnStart = document.getElementById('btnStart');
  const btnSwitch = document.getElementById('btnSwitch');
  const btnPhoto  = document.getElementById('btnPhoto');

  const result = document.getElementById('result');
  const resultImg = document.getElementById('resultImg');
  const btnBack = document.getElementById('btnBack');
  const btnShare = document.getElementById('btnShare');

  let stream = null;
  let facing = 'user';
  let lastDataUrl = null;

  const sleep = ms => new Promise(r => setTimeout(r, ms));

  async function waitForVideo() {
    while (video.videoWidth === 0 || video.videoHeight === 0) await sleep(16);
  }

  function resizeCanvas() {
    const w = video.videoWidth, h = video.videoHeight;
    if (w && h && (canvas.width !== w || canvas.height !== h)) {
      canvas.width = w; canvas.height = h;
    }
  }

  async function startCamera() {
    try {
      if (stream) stream.getTracks().forEach(t => t.stop());
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: facing },
        audio: false
      });
      video.srcObject = stream;
      video.muted = true;
      await video.play();
      await waitForVideo();
      resizeCanvas();
    } catch (e) {
      alert('Камера не запустилась. Проверь разрешения.');
      console.error(e);
    }
  }

  function drawGridCentral10cm() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const hCm = parseInt(heightInput.value, 10);
    if (!hCm || hCm <= 0) return;

    const pxPerCm = canvas.height / hCm;
    const stepPx = pxPerCm * 10; // 10 см

    const W = canvas.width;
    const H = canvas.height;
    const centerX = W / 2;

    // вертикальные линии: от центра влево/вправо
    ctx.lineWidth = 1;
    ctx.strokeStyle = 'rgba(255,255,255,0.25)';
    for (let x = centerX; x <= W; x += stepPx) {
      ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
    }
    for (let x = centerX - stepPx; x >= 0; x -= stepPx) {
      ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
    }

    // горизонтальные линии: от низа вверх (привязка к росту)
    for (let y = H; y >= 0; y -= stepPx) {
      ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
    }

    // центральная линия сетки (синяя)
    ctx.lineWidth = 3;
    ctx.strokeStyle = 'rgba(0,170,255,0.95)';
    ctx.beginPath();
    ctx.moveTo(centerX, 0);
    ctx.lineTo(centerX, H);
    ctx.stroke();

    // подпись шага (всегда видна)
    ctx.fillStyle = 'rgba(255,255,255,0.95)';
    ctx.font = '22px Arial';
    ctx.fillText('Шаг сетки: 10 см', 16, 34);
  }

  async function runCountdown(seconds) {
    for (let i = seconds; i > 0; i--) {
      countdown.textContent = i;
      countdown.style.display = 'flex';
      await sleep(1000);
    }
    countdown.style.display = 'none';
  }

  function composeCapture() {
    const out = document.createElement('canvas');
    out.width = canvas.width; out.height = canvas.height;
    const octx = out.getContext('2d');
    octx.drawImage(video, 0, 0);
    octx.drawImage(canvas, 0, 0);
    return out.toDataURL('image/png');
  }

  async function takePhoto() {
    if (!video.srcObject) return alert('Сначала включи камеру');
    const hCm = parseInt(heightInput.value, 10);
    if (!hCm || hCm <= 0) return alert('Введи рост (см)');

    await waitForVideo();
    resizeCanvas();
    drawGridCentral10cm();

    if (facing === 'user') {
      await runCountdown(8);
      resizeCanvas();
      drawGridCentral10cm();
    }

    lastDataUrl = composeCapture();
    resultImg.src = lastDataUrl;
    result.style.display = 'flex';
  }

  btnStart.onclick = startCamera;
  btnSwitch.onclick = async () => {
    facing = (facing === 'user') ? 'environment' : 'user';
    await startCamera();
  };
  btnPhoto.onclick = takePhoto;

  btnBack.onclick = () => { result.style.display = 'none'; };

  btnShare.onclick = async () => {
    if (!lastDataUrl) return;
    try {
      const blob = await (await fetch(lastDataUrl)).blob();
      const file = new File([blob], 'posture.png', { type:'image/png' });
      if (navigator.canShare && navigator.canShare({ files:[file] }) && navigator.share) {
        await navigator.share({ files:[file], title:'Posture' });
      } else {
        alert('Удерживай палец на фото → «Сохранить в Фото»');
      }
    } catch {
      alert('Удерживай палец на фото → «Сохранить в Фото»');
    }
  };

  (function loop(){
    if (video.videoWidth) {
      resizeCanvas();
      drawGridCentral10cm();
    }
    requestAnimationFrame(loop);
  })();
})();
</script>

</body>
</html>
